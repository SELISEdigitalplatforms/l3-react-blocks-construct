name: Reusable - SCA Scan JS/TS

on:
  workflow_call:
    inputs:
      # ========================================
      # General Configuration
      # ========================================
      PROJECT_NAME:
        description: "Project name for Dependency-Track (defaults to repository name)"
        required: false
        type: string
        default: ""

      PROJECT_VERSION:
        description: "Project version for Dependency-Track (defaults to branch/tag name)"
        required: false
        type: string
        default: ""

      NODE_VERSION:
        description: "Node.js version to use"
        required: false
        type: string
        default: "20"

      # ========================================
      # Package Manager Configuration
      # ========================================
      PACKAGE_MANAGER:
        description: "Package manager to use (npm, yarn, pnpm)"
        required: false
        type: string
        default: "npm"

      INSTALL_COMMAND:
        description: "Command to install dependencies (e.g., 'ci', 'install --frozen-lockfile')"
        required: false
        type: string
        default: "ci"

      # ========================================
      # Dependency-Track Configuration
      # ========================================
      SKIP_DEPENDENCY_INSTALL:
        description: "Skip dependency installation (useful for cdxgen)"
        required: false
        type: boolean
        default: false

      SBOM_TOOL:
        description: "SBOM generation tool (cdxgen, cyclonedx-npm)"
        required: false
        type: string
        default: "cdxgen"

      CYCLONEDX_NPM_VERSION:
        description: "CycloneDX NPM version (auto-detected if empty)"
        required: false
        type: string
        default: ""

      CDXGEN_VERSION:
        description: "cdxgen version (auto-detected if empty)"
        required: false
        type: string
        default: ""

      USE_DOCKER:
        description: "Use Docker version of cdxgen (requires cdxgen as SBOM_TOOL)"
        required: false
        type: boolean
        default: false

      INCLUDE_FORMULATION:
        description: "Include build/CI info in SBOM (cdxgen only)"
        required: false
        type: boolean
        default: true

      DEPENDENCY_TRACK_HOST:
        description: "Dependency-Track API server hostname (backend)"
        required: false
        type: string
        default: "api-dt.seliseblocks.com"

      DEPENDENCY_TRACK_FRONTEND_URL:
        description: "Dependency-Track frontend URL (for dashboard links)"
        required: false
        type: string
        default: "sca.seliseblocks.com"

      SBOM_FILENAME:
        description: "SBOM filename to generate (JSON format only)"
        required: false
        type: string
        default: "bom.json"
      AUTO_CREATE_PROJECT:
        description: "Auto-create project in Dependency-Track if it doesn't exist"
        required: false
        type: boolean
        default: true

      ARTIFACT_RETENTION_DAYS:
        description: "Number of days to retain SBOM artifact"
        required: false
        type: number
        default: 2

      # ========================================
      # Optional Features
      # ========================================
      HAS_SUBMODULES:
        description: "Set to true if repository uses Git submodules"
        required: false
        type: boolean
        default: false

    secrets:
      DEPENDENCY_TRACK_API_KEY:
        required: true
        description: "Dependency-Track API key"

      SELISE_GITHUB_PAT:
        required: false
        description: "GitHub PAT for private repositories and submodules"

jobs:
  sca-scan:
    name: SCA Scan & SBOM Upload
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: ${{ inputs.HAS_SUBMODULES && 'recursive' || 'false' }}
          token: ${{ secrets.SELISE_GITHUB_PAT || github.token }}

      - name: Update submodules
        if: inputs.HAS_SUBMODULES
        run: |
          git submodule update --init --recursive
          echo "âœ… Submodules updated" >> $GITHUB_STEP_SUMMARY

      - name: Set up Docker Buildx
        if: inputs.SBOM_TOOL == 'cdxgen' && inputs.USE_DOCKER
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        if: inputs.SBOM_TOOL == 'cdxgen' && inputs.USE_DOCKER
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-cdxgen-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cdxgen-

      - name: Pull cdxgen Docker image
        if: inputs.SBOM_TOOL == 'cdxgen' && inputs.USE_DOCKER
        run: |
          echo "ðŸ“¥ Pulling cdxgen Docker image..."
          docker pull ghcr.io/cyclonedx/cdxgen:master
          echo "âœ… Docker image cached" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node.js
        if: ${{ !inputs.USE_DOCKER }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}

      - name: Install dependencies
        # if: ${{ !inputs.SKIP_DEPENDENCY_INSTALL }}
        if: ${{ !inputs.SKIP_DEPENDENCY_INSTALL && !inputs.USE_DOCKER }}
        run: |
          echo "ðŸ“¦ Installing dependencies with ${{ inputs.PACKAGE_MANAGER }}..."
          if [ "${{ inputs.PACKAGE_MANAGER }}" = "npm" ]; then
            if [ "${{ inputs.INSTALL_COMMAND }}" = "ci" ]; then
              npm ci --legacy-peer-deps || npm install --legacy-peer-deps
            else
              npm ${{ inputs.INSTALL_COMMAND }} --legacy-peer-deps
            fi
          else
            ${{ inputs.PACKAGE_MANAGER }} ${{ inputs.INSTALL_COMMAND }}
          fi
          echo "âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY

      - name: Determine project configuration
        id: config
        run: |
          # Determine project name
          if [ -n "${{ inputs.PROJECT_NAME }}" ]; then
            PROJECT_NAME="${{ inputs.PROJECT_NAME }}"
          else
            PROJECT_NAME="${{ github.event.repository.name }}"
          fi
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT

          # Determine project version
          if [ -n "${{ inputs.PROJECT_VERSION }}" ]; then
            PROJECT_VERSION="${{ inputs.PROJECT_VERSION }}"
          else
            PROJECT_VERSION="${{ github.ref_name }}"
          fi
          echo "project_version=$PROJECT_VERSION" >> $GITHUB_OUTPUT

          # Summary
          echo "### ðŸ” SCA Scan Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: \`$PROJECT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`$PROJECT_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package Manager**: ${{ inputs.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Tool**: ${{ inputs.SBOM_TOOL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ inputs.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY

      - name: Determine tool version
        if: ${{ !inputs.USE_DOCKER }}
        id: tool-version
        run: |
          NODE_MAJOR=$(node -v | cut -d'.' -f1 | sed 's/v//')

          if [ "${{ inputs.SBOM_TOOL }}" = "cdxgen" ]; then
            if [ -n "${{ inputs.CDXGEN_VERSION }}" ]; then
              # User specified version
              VERSION="${{ inputs.CDXGEN_VERSION }}"
              echo "âœ… Using specified cdxgen version: $VERSION" >> $GITHUB_STEP_SUMMARY
              
            elif [ "$NODE_MAJOR" -ge 20 ]; then
              # Node 20+: Latest cdxgen
              VERSION="latest"
              echo "âœ… Node $NODE_MAJOR: using latest cdxgen" >> $GITHUB_STEP_SUMMARY
              
            elif [ "$NODE_MAJOR" -ge 18 ]; then
              # Node 18-19: Compatibility gap - must use Docker
              echo "âŒ Node $NODE_MAJOR: cdxgen cannot be installed via npm" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ Solution 1: Set USE_DOCKER: true" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ Solution 2: Upgrade to NODE_VERSION: \"20\"" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ Solution 3: Downgrade to NODE_VERSION: \"16\"" >> $GITHUB_STEP_SUMMARY
              exit 1
              
            else
              # Node 17 and below: cdxgen 9.x
              VERSION="8.6.3"
              echo "âœ… Node $NODE_MAJOR: using cdxgen@8.6.3" >> $GITHUB_STEP_SUMMARY
            fi
            
          else
            # cyclonedx-npm
            if [ -n "${{ inputs.CYCLONEDX_NPM_VERSION }}" ]; then
              VERSION="${{ inputs.CYCLONEDX_NPM_VERSION }}"
            elif [ "$NODE_MAJOR" -lt 16 ]; then
              VERSION="1.9.2"
            elif [ "$NODE_MAJOR" -lt 19 ]; then
              VERSION="1.17.0"
            else
              VERSION="latest"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate SBOM with cdxgen (Docker)
        if: inputs.SBOM_TOOL == 'cdxgen' && inputs.USE_DOCKER
        run: |
          echo "ðŸ“‹ Generating SBOM with cdxgen (Docker)..."

          FORMULATION_FLAG=""
          [ "${{ inputs.INCLUDE_FORMULATION }}" = "true" ] && FORMULATION_FLAG="--include-formulation"

          # Create a temporary output directory with proper permissions
          mkdir -p /tmp/cdxgen-output
          chmod 777 /tmp/cdxgen-output

          # # Run Docker - output to /tmp (accessible by container)
          # docker run --rm \
          #   -v $(pwd):/app:ro \
          #   -v /tmp/cdxgen-output:/output:rw \
          #   ghcr.io/cyclonedx/cdxgen:master \
          #   -r /app \
          #   -o /output/${{ inputs.SBOM_FILENAME }} \
          #   -t js \
          #   --spec-version 1.5 \
          #   --include-crypto \
          #   --deep \
          #   $FORMULATION_FLAG
          # Run Docker - output to /tmp (accessible by container)

          docker run --rm \
            -v $(pwd):/app:ro \
            -v /tmp/cdxgen-output:/output:rw \
            -t ghcr.io/cyclonedx/cdxgen:master \
            -r /app \
            -o /output/${{ inputs.SBOM_FILENAME }} \
            --include-crypto \
            --deep \
            $FORMULATION_FLAG

          # Move SBOM to workspace
          mv /tmp/cdxgen-output/${{ inputs.SBOM_FILENAME }} ${{ inputs.SBOM_FILENAME }}

          # Cleanup
          rm -rf /tmp/cdxgen-output

          echo "âœ… SBOM generated" >> $GITHUB_STEP_SUMMARY

      - name: Generate SBOM with cdxgen (NPM)
        if: inputs.SBOM_TOOL == 'cdxgen' && !inputs.USE_DOCKER
        run: |
          echo "ðŸ“‹ Generating SBOM with cdxgen..."
          npm install -g @cyclonedx/cdxgen@${{ steps.tool-version.outputs.version }}

          FORMULATION_FLAG=""
          [ "${{ inputs.INCLUDE_FORMULATION }}" = "true" ] && FORMULATION_FLAG="--include-formulation"

          cdxgen \
            -o ${{ inputs.SBOM_FILENAME }} \
            -t js \
            --spec-version 1.5 \
            --include-crypto \
            --deep \
            $FORMULATION_FLAG \
            .

          echo "âœ… SBOM generated" >> $GITHUB_STEP_SUMMARY

      - name: Generate SBOM with CycloneDX NPM
        if: inputs.SBOM_TOOL == 'cyclonedx-npm'
        run: |
          echo "ðŸ“‹ Generating SBOM with CycloneDX NPM..."

          npx @cyclonedx/cyclonedx-npm@${{ steps.tool-version.outputs.version }} \
            --output-file ${{ inputs.SBOM_FILENAME }} \
            --output-format json

          echo "âœ… SBOM generated" >> $GITHUB_STEP_SUMMARY

      - name: Validate and show SBOM stats
        run: |
          [ ! -f "${{ inputs.SBOM_FILENAME }}" ] && echo "âŒ SBOM not found" && exit 1
          [ ! -s "${{ inputs.SBOM_FILENAME }}" ] && echo "âŒ SBOM is empty" && exit 1

          FILE_SIZE=$(ls -lh ${{ inputs.SBOM_FILENAME }} | awk '{print $5}')
          echo "- **File Size**: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY

          if command -v jq &> /dev/null; then
            if jq empty ${{ inputs.SBOM_FILENAME }} 2>/dev/null; then
              COMPONENTS=$(jq -r '.components | length' ${{ inputs.SBOM_FILENAME }} 2>/dev/null || echo "N/A")
              DEPENDENCIES=$(jq -r '.dependencies | length' ${{ inputs.SBOM_FILENAME }} 2>/dev/null || echo "N/A")
              echo "- **Components**: $COMPONENTS" >> $GITHUB_STEP_SUMMARY
              echo "- **Dependencies**: $DEPENDENCIES" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Invalid JSON format" && exit 1
            fi
          fi

          echo "âœ… SBOM validation passed" >> $GITHUB_STEP_SUMMARY

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: ${{ inputs.SBOM_FILENAME }}
          retention-days: ${{ inputs.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

      - name: Upload to Dependency-Track
        uses: DependencyTrack/gh-upload-sbom@v3.1.0
        with:
          serverhostname: ${{ inputs.DEPENDENCY_TRACK_HOST }}
          apikey: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}
          projectname: ${{ steps.config.outputs.project_name }}
          projectversion: ${{ steps.config.outputs.project_version }}
          bomfilename: ${{ inputs.SBOM_FILENAME }}
          autocreate: ${{ inputs.AUTO_CREATE_PROJECT }}

      - name: SCA Scan Summary
        if: always()
        run: |
          echo "## ðŸ“Š SCA Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ steps.config.outputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.config.outputs.project_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Tool**: ${{ inputs.SBOM_TOOL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Format**: CycloneDX json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard**: https://${{ inputs.DEPENDENCY_TRACK_FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Projects**: https://${{ inputs.DEPENDENCY_TRACK_FRONTEND_URL }}/projects" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Artifact**: Available in workflow artifacts for ${{ inputs.ARTIFACT_RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
